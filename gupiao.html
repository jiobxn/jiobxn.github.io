<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CSV Viewer (Google Finance style)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#fff;
      --muted:#6b7280;
      --accent:#EA4335; /* Google Finance red */
      --accent-weak:#ffdede;
      --card-shadow:0 6px 18px rgba(17,24,39,0.08);
      font-family:"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }
    body{
      margin:0;
      background:linear-gradient(180deg,#fbfbfd,#fff);
      color:#111827;
      padding:20px;
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:1100px;margin:0 auto;}

    .top-card{
      background:var(--bg);
      padding:18px;
      border-radius:12px;
      box-shadow:var(--card-shadow);
      margin-bottom:18px;
    }
    .dynamic-title{
      font-size:20px;
      font-weight:700;
      margin-bottom:10px;
    }
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid #e6e9ef;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
    }
    .chart-wrapper{
      margin-top:30px;
      background:var(--bg);
      padding:10px; /* å‡å°‘paddingä»¥æ‰©å¤§å›¾è¡¨å¯ç”¨ç©ºé—´ */
      border-radius:12px;
      box-shadow:var(--card-shadow);
      display:flex;
      justify-content:center;
    }
    .chart-area{
      width:100%;
      max-width:1000px; /* å¢åŠ max-widthï¼Œå‡å°‘ä¸¤ä¾§ç©ºç™½ */
    }
    /* å¢åŠ å›¾è¡¨é«˜åº¦ä¸º 360pxï¼ˆæ¯”ä¹‹å‰ç•¥é«˜ï¼‰ */
    canvas{width:100% !important;height:360px !important;}
    .table-card{
      margin-top:18px;
      background:var(--bg);
      padding:12px;
      border-radius:12px;
      box-shadow:var(--card-shadow);
    }
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #f1f5f9;}
    th{color:var(--muted);font-weight:600;font-size:13px;}
    tr:hover td{background:#fff9f9}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .file-input{display:none}
    .uploader{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:8px;
      padding:8px 12px;
      background:#fff;
      border:1px dashed #e6e9ef;
      cursor:pointer;
      font-size:13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-card">
      <div class="dynamic-title" id="dynamicTitle">Sample Data</div>

      <div class="controls">
        <label class="uploader" title="Upload CSV">
          <input id="file" class="file-input" type="file" accept=".csv,text/csv" />
          ä¸Šä¼  CSV
        </label>
        <button id="resetBtn" class="btn">æ¢å¤ç¤ºä¾‹</button>
        <button class="btn" data-range="1M">1 ä¸ªæœˆ</button>
        <button class="btn" data-range="6M">6 ä¸ªæœˆ</button>
        <button class="btn" data-range="YTD">YTD</button>
        <button class="btn" data-range="1Y">1 å¹´</button>
        <button class="btn" data-range="5Y">5 å¹´</button>
        <button class="btn" id="fitBtn">å…¨éƒ¨</button>
        <button class="btn" id="prevYear">ä¸Šä¸€å¹´</button>
        <button class="btn" id="nextYear">ä¸‹ä¸€å¹´</button>
        <div style="margin-left:auto;color:var(--muted);font-size:13px">CSV è¡Œ: <span id="rowCount">0</span></div>
      </div>
    </div>

    <!-- å›¾è¡¨ç‹¬ç«‹ä¸€è¡Œ -->
    <div class="chart-wrapper">
      <div class="chart-area">
        <canvas id="priceChart"></canvas>
      </div>
    </div>

    <div class="table-card">
      <table id="dataTable">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th class="right">æ”¶ç›˜</th>
            <th class="right">å¼€ç›˜</th>
            <th class="right">é«˜</th>
            <th class="right">ä½</th>
            <th class="right">äº¤æ˜“é‡</th>
            <th class="right">æ¶¨è·Œå¹…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    /************************************************************************
     * Sample CSV (ä½ ä¹‹å‰ç»™çš„ç¤ºä¾‹) â€” é¡µé¢åˆå§‹ä½¿ç”¨æ­¤ç¤ºä¾‹ï¼Œå¯ä¸Šä¼ æˆ–æ‹–æ‹½ CSV æ›¿æ¢
     ************************************************************************/
    const sampleCSV = `"æ—¥æœŸ","æ”¶ç›˜","å¼€ç›˜","é«˜","ä½","äº¤æ˜“é‡","æ¶¨è·Œå¹…"
"2025-10-22","443.11","443.46","445.39","441.49","4.78M","0.12%"
"2025-10-21","442.60","445.76","449.30","442.05","54.41M","-1.08%"
"2025-10-20","447.43","443.86","449.80","440.61","63.72M","1.85%"
"2025-10-17","439.31","425.50","441.46","423.60","89.33M","2.46%"
"2025-10-16","428.75","434.73","439.35","421.31","77.19M","-1.47%"
"2025-10-15","435.15","434.90","440.51","426.33","71.56M","1.38%"
"2025-10-14","429.24","426.79","434.20","417.86","72.67M","-1.53%"
"2025-10-13","435.90","423.53","436.89","419.70","79.55M","5.42%"`;

    /************************************************************************
     * å°å·¥å…·ï¼šè§£æäº¤æ˜“é‡ï¼ˆ"4.78M" -> æ•°å­—ï¼‰ï¼Œä»¥åŠæ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆå¸¦å•ä½ï¼‰
     ************************************************************************/
    function parseVolume(volStr){
      if(!volStr) return null;
      volStr = volStr.toString().trim().replace(/,/g,'');
      const last = volStr.slice(-1).toUpperCase();
      let num = parseFloat(volStr);
      if(isNaN(num)){
        const val = parseFloat(volStr.slice(0, -1));
        if(isNaN(val)) return volStr;
        if(last==='M') num = val*1e6;
        else if(last==='K') num = val*1e3;
        else if(last==='B') num = val*1e9;
        else num = val;
      }
      return Math.round(num);
    }
    function fmtVolume(n){
      if(n===null||n===undefined) return '-';
      if(typeof n!=='number') return n;
      if(n>=1e9) return (n/1e9).toFixed(2)+'B';
      if(n>=1e6) return (n/1e6).toFixed(2)+'M';
      if(n>=1e3) return (n/1e3).toFixed(1)+'K';
      return n.toString();
    }

    /************************************************************************
     * CSV è§£æä¸è§„èŒƒåŒ–ï¼ˆä¿æŒä¹‹å‰é€»è¾‘ï¼Œè¿”å›æŒ‰æ—¥æœŸå‡åºæ’åˆ—çš„ rowsï¼‰
     ************************************************************************/
    function parseCSVText(text){
      const res = Papa.parse(text.trim(), {header:true, skipEmptyLines:true});
      return res.data.map(r=>{
        const norm={};
        for(const k in r){
          const key=k.trim().replace(/^"|"$/g,'');
          norm[key]=(r[k]||'').toString().replace(/^"|"$/g,'');
        }
        return norm;
      });
    }

    function normalizeRows(rows){
      const dateKey=Object.keys(rows[0]).find(k=>/æ—¥æœŸ|Date/i.test(k))||Object.keys(rows[0])[0];
      const map=rows.map(r=>{
        let dstr=r[dateKey].replace(/"/g,'').trim().replace(/\//g, '-'); // ç»Ÿä¸€æ›¿æ¢ / ä¸º -ï¼Œä¿æŒ YYYY-MM-DD æ ¼å¼
        // è§£ææ—¥æœŸï¼šå¦‚æœæ˜¯ '2025-10-22' è¿™ç§æ ¼å¼ï¼ŒSafari å¯èƒ½è§£ææœ‰é—®é¢˜ï¼Œç”¨æ›¿æ¢
        const dateParts = dstr.split(/[-\/]/);
        let date = new Date(dstr);
        if(date.toString() === 'Invalid Date' && dateParts.length>=3){
          // YYYY-MM-DD or YYYY/MM/DD
          date = new Date(parseInt(dateParts[0],10), parseInt(dateParts[1],10)-1, parseInt(dateParts[2],10));
        }
        return {
          raw:r,
          date,
          dateStr:dstr,
          close:parseFloat((r['æ”¶ç›˜']||r['Close']||'').replace(/,/g,''))||NaN,
          open:parseFloat((r['å¼€ç›˜']||r['Open']||'').replace(/,/g,''))||NaN,
          high:parseFloat((r['é«˜']||r['High']||'').replace(/,/g,''))||NaN,
          low:parseFloat((r['ä½']||r['Low']||'').replace(/,/g,''))||NaN,
          volumeRaw:(r['äº¤æ˜“é‡']||r['Volume']||''),
          volume:(r['äº¤æ˜“é‡']||r['Volume']||''),
          pct:(r['æ¶¨è·Œå¹…']||r['%']||'')
        };
      });
      // å‡åºï¼ˆä»æ—©åˆ°æ™šï¼‰
      map.sort((a,b)=>a.date-b.date);
      return map;
    }

    function renderTable(rows){
      const tbody=document.querySelector('#dataTable tbody');
      tbody.innerHTML='';
      const showRows=[...rows].reverse(); // newest first
      showRows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${r.dateStr}</td>
          <td class="right">${isNaN(r.close)?'-':r.close.toFixed(2)}</td>
          <td class="right">${isNaN(r.open)?'-':r.open.toFixed(2)}</td>
          <td class="right">${isNaN(r.high)?'-':r.high.toFixed(2)}</td>
          <td class="right">${isNaN(r.low)?'-':r.low.toFixed(2)}</td>
          <td class="right">${fmtVolume(r.volume)}</td>
          <td class="right">${r.pct||'-'}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('rowCount').textContent = showRows.length;
    }

    /************************************************************************
     * Chart éƒ¨åˆ†ï¼ˆå¢åŠ  crosshair æ’ä»¶ã€æ™ºèƒ½ X è½´æ ‡ç­¾ã€tooltip æ˜¾ç¤º volumeï¼‰
     ************************************************************************/
    let chart = null;
    // å­˜æ”¾å½“å‰å…¨éƒ¨ rowsï¼Œæ–¹ä¾¿ tooltip/crosshair ä½¿ç”¨
    let currentRows = [];
    let currentDataRows = []; // å½“å‰æ˜¾ç¤ºçš„ dataRows
    // æ–°å¢ï¼šå¹´å¯¼èˆªçŠ¶æ€
    let yearNavigationMode = false;
    let currentYearOffset = 0; // ç›¸å¯¹äºæ•°æ®æœ€åä¸€å¹´ä»½çš„åç§»ï¼ˆè´Ÿå€¼ä¸ºè¿‡å»ï¼Œæ­£å€¼ä¸ºæœªæ¥ï¼Œä½†æ•°æ®æœ‰é™ï¼‰

    // è‡ªå®šä¹‰ crosshair æ’ä»¶ï¼ˆåœ¨ afterDraw ç»˜åˆ¶ç«–è™šçº¿ï¼‰
    const crosshairPlugin = {
      id: 'verticalCrosshair',
      afterDraw(chartInstance, args, options) {
        const ctx = chartInstance.ctx;
        const tooltip = chartInstance.tooltip;
        // å½“ tooltip å­˜åœ¨å¹¶ä¸”æ¿€æ´»å…ƒç´ å­˜åœ¨æ—¶ï¼Œæ˜¾ç¤ºç«–çº¿
        if (tooltip && tooltip.getActiveElements && tooltip.getActiveElements().length) {
          const active = tooltip.getActiveElements()[0];
          if(active && active.element){
            const x = active.element.x;
            const topY = chartInstance.scales.y.top;
            const bottomY = chartInstance.scales.y.bottom;
            ctx.save();
            // é‡‡ç”¨ destination-over ç»˜åˆ¶åœ¨æ›²çº¿ä¹‹ä¸‹ï¼ˆå¦‚æœç”»å¸ƒæ”¯æŒï¼‰ï¼Œä»¥é˜²é®æŒ¡æ›²çº¿
            // ä½†éƒ¨åˆ†æµè§ˆå™¨/åœºæ™¯ destination-over å¯èƒ½æ— æ•ˆæœï¼Œæ‰€ä»¥æŠŠçº¿ç”»å¾—å°½é‡æ·¡
            ctx.setLineDash([4,4]);
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.moveTo(x, topY);
            ctx.lineTo(x, bottomY);
            ctx.stroke();
            ctx.restore();
          }
        }
      }
    };

    // å°†æ’ä»¶æ³¨å†Œåˆ° Chart.js
    Chart.register(crosshairPlugin);

    // æ ¹æ® rows èŒƒå›´åˆ¤æ–­åº”è¯¥æ˜¾ç¤ºçš„ X è½´åˆ»åº¦æ ¼å¼
    function getTickFormatterForSpan(rows){
      if(!rows || rows.length < 2) return function(value){ return value; };
      const first = rows[0].date;
      const last = rows[rows.length-1].date;
      const spanDays = (last - first) / (1000*60*60*24);
      // > 5 å¹´ï¼šåªæ˜¾ç¤ºå¹´ä»½
      if(spanDays > 365 * 5){
        return function(value, index, ticks){
          // value æ˜¯æ ‡ç­¾å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬è§£æä¸º Date
          const d = new Date(value);
          if(isNaN(d)) {
            // å°è¯•ä» "YYYY-MM-DD"
            const p = value.split(/[-\/]/);
            if(p.length>=3) return p[0];
            return value;
          }
          return d.getFullYear().toString();
        };
      }
      // > 6 ä¸ªæœˆï¼šæ˜¾ç¤º å¹´æœˆï¼ˆå¦‚ "2025å¹´3æœˆ"ï¼‰
      if(spanDays > 30 * 6){
        return function(value, index, ticks){
          const d = new Date(value);
          if(isNaN(d)){
            const p = value.split(/[-\/]/);
            if(p.length>=3) return p[0] + 'å¹´' + (parseInt(p[1],10)) + 'æœˆ';
            return value;
          }
          return d.getFullYear() + 'å¹´' + (d.getMonth()+1) + 'æœˆ';
        };
      }
      // å¦åˆ™ï¼šæ˜¾ç¤ºçŸ­æ—¥æœŸ MM-DD
      return function(value, index, ticks){
        const d = new Date(value);
        if(isNaN(d)){
          const p = value.split(/[-\/]/);
          if(p.length>=3) return p[1] + '-' + p[2];
          return value;
        }
        const mm = (d.getMonth()+1).toString().padStart(2,'0');
        const dd = d.getDate().toString().padStart(2,'0');
        return mm + '-' + dd;
      };
    }

    // ç»˜åˆ¶å›¾è¡¨ï¼ˆrows ä¸ºå‡åºï¼‰
    function drawChart(rows, range=null){
      currentRows = rows; // æ›´æ–°å…¨å±€å¼•ç”¨
      let dataRows = rows;
      if(range){
        const lastDate = rows[rows.length-1].date;
        let cutoff;
        if(range === '1M'){ cutoff = new Date(lastDate); cutoff.setMonth(cutoff.getMonth()-1); }
        else if(range === '6M'){ cutoff = new Date(lastDate); cutoff.setMonth(cutoff.getMonth()-6); }
        else if(range === 'YTD'){ cutoff = new Date(lastDate.getFullYear(), 0, 1); }
        else if(range === '1Y'){ 
          // å¯¹äº1Yï¼Œå¯ç”¨å¹´å¯¼èˆªæ¨¡å¼ï¼ŒåŸºäºå½“å‰offsetè®¡ç®—
          yearNavigationMode = true;
          const baseYear = lastDate.getFullYear();
          const targetYear = baseYear - currentYearOffset;
          cutoff = new Date(targetYear, 0, 1);
          const endDate = new Date(targetYear, 11, 31, 23, 59, 59);
          dataRows = rows.filter(r => r.date >= cutoff && r.date <= endDate);
          if(dataRows.length === 0) {
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œfallbackåˆ°é»˜è®¤1Y
            cutoff = new Date(lastDate); cutoff.setFullYear(cutoff.getFullYear()-1);
            dataRows = rows.filter(r => r.date >= cutoff);
            yearNavigationMode = false;
          }
        }
        else if(range === '5Y'){ cutoff = new Date(lastDate); cutoff.setFullYear(cutoff.getFullYear()-5); }
        if(cutoff && range !== '1Y') dataRows = rows.filter(r => r.date >= cutoff);
      } else {
        yearNavigationMode = false;
      }
      currentDataRows = dataRows; // æ›´æ–°å½“å‰ dataRows

      // è®¡ç®—å½“å‰æ˜¾ç¤ºæ•°æ®ï¼ˆdataRowsï¼‰çš„è·¨åº¦
      const firstDate = dataRows[0].date;
      const lastDate = dataRows[dataRows.length - 1].date;
      const spanDays = (lastDate - firstDate) / (1000 * 60 * 60 * 24);

      // ğŸŒˆ å¹³æ»‘å¤„ç†é€»è¾‘ï¼šåªåœ¨è¶…è¿‡5å¹´æ—¶åº”ç”¨ç§»åŠ¨å¹³å‡ï¼ˆä¿æŒä¸€å¹´æˆ–ä»¥ä¸‹åŸæ ·ï¼‰
      let closes = dataRows.map(r => r.close);
      if(spanDays > 365 * 4){          // è¶…è¿‡5å¹´
        const smooth = [];
        const window = 2;              // å¯è°ƒèŠ‚ï¼šæ•°å­—è¶Šå¤§è¶Šå¹³æ»‘
        for(let i=0; i<closes.length; i++){
          const start = Math.max(0, i-window);
          const end = Math.min(closes.length-1, i+window);
          const subset = closes.slice(start, end+1);
          const avg = subset.reduce((a,b)=>a+b,0)/subset.length;
          smooth.push(avg);
        }
        closes = smooth;
      }

      // åŠ¨æ€ tensionï¼šä¸€å¹´æˆ–ä»¥ä¸‹ä¿æŒä½å€¼ï¼ˆåŸæ ·ï¼Œå°–é”æ›²çº¿ï¼‰ï¼Œ1-5å¹´ä¸­ç­‰ï¼Œ>5å¹´æ›´é«˜å¹³æ»‘
      let tension = 0.2; // é»˜è®¤ï¼šä¸€å¹´æˆ–ä»¥ä¸‹ï¼ŒåŸæ ·
      if (spanDays > 365 * 1 && spanDays <= 365 * 5) { // 1-5å¹´ï¼šä¸­ç­‰å¹³æ»‘
        tension = 0.3;
      } else if (spanDays > 365 * 5) { // >5å¹´ï¼šæ›´é«˜å¹³æ»‘
        tension = 0.45;
      }

      const labels = dataRows.map(r => r.dateStr);

      const ctx = document.getElementById('priceChart').getContext('2d');
      if(chart) chart.destroy();

      const tickFormatter = getTickFormatterForSpan(rows);

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Close',
            data: closes,
            borderWidth: 2,
            tension: tension, // ä½¿ç”¨åŠ¨æ€ tension
            borderColor: '#EA4335',
            backgroundColor: (context) => {
              const chart = context.chart;
              const {ctx, chartArea} = chart;
              if (!chartArea) return null;
              const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
              gradient.addColorStop(0, 'rgba(234, 67, 53, 0)');
              gradient.addColorStop(0.5, 'rgba(234, 67, 53, 0.08)');
              gradient.addColorStop(1, 'rgba(234, 67, 53, 0.4)');
              return gradient;
            },
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointBackgroundColor: 'white',
            pointHoverBorderColor: '#EA4335',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(255, 255, 255, 0.95)', // æµ…ç™½è‰²èƒŒæ™¯ï¼Œæ— é¢œè‰²å¡«å……
              titleColor: '#333', // æ ‡é¢˜é¢œè‰²
              bodyColor: '#666', // ä¸»ä½“é¢œè‰²
              borderColor: 'rgba(0, 0, 0, 0.1)', // è¾¹æ¡†æµ…ç°
              borderWidth: 1,
              cornerRadius: 4,
              displayColors: false, // éšè—é¢œè‰²å—
              callbacks: {
                label: function(ctx){
                  const idx = ctx.dataIndex;
                  const value = ctx.raw;
                  return Number(value).toFixed(2); // å»æ‰"æ”¶ç›˜:"ï¼Œåªæ˜¾ç¤ºæ•°å€¼
                },
                title: function(items){ return items.length ? items[0].label : ''; }
              }
            }
          },
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 8,
                callback: function (val, index, ticks) {
                  const labels = this.getLabelForValue(val);
                  const first = currentDataRows[0].date;
                  const last = currentDataRows[currentDataRows.length - 1].date;
                  const months = (last - first) / (1000 * 60 * 60 * 24 * 30);
                  const years = months / 12;

                  const d = new Date(labels);
                  if (years > 5) return `${d.getFullYear()}`;
                  if (months > 6) return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
                  return labels;
                }
              }
            },
            y: { grid: { color: '#f3f4f6' } }
          },
          interaction: { mode: 'index', intersect: false }
        },
        plugins: [crosshairPlugin]
      });
    }

    /************************************************************************
     * ä¸»åŠ è½½å‡½æ•°ï¼šè§£æ CSV -> æ¸²æŸ“ table/chart -> ç»‘å®šæŒ‰é’®
     ************************************************************************/
    function loadFromCSVText(text, filename = 'Sample Data'){
      try{
        document.getElementById('dynamicTitle').textContent = filename;
        const rawRows = parseCSVText(text);
        if(!rawRows || rawRows.length === 0){ alert('CSV è§£æå¤±è´¥æˆ–ä¸ºç©º'); return; }
        const rows = normalizeRows(rawRows);
        renderTable(rows);
        drawChart(rows);
        // é‡ç½®å¹´å¯¼èˆªçŠ¶æ€
        yearNavigationMode = false;
        currentYearOffset = 0;
        // ç»‘å®šèŒƒå›´æŒ‰é’®ï¼šåªéœ€ä¼ å…¥ rows åˆ° drawChart
        document.querySelectorAll('.controls .btn[data-range]').forEach(b=>{
          b.onclick = ()=>{
            // è§†è§‰ä¸Šä¸éœ€è¦ç‰¹åˆ«é«˜äº®ï¼Œä»…è§¦å‘ç»˜åˆ¶
            drawChart(rows, b.dataset.range);
          };
        });
        document.getElementById('fitBtn').onclick = ()=> drawChart(rows, null);
        // æ–°å¢ï¼šç»‘å®šå¹´å¯¼èˆªæŒ‰é’®
        document.getElementById('prevYear').onclick = ()=>{
          if(!yearNavigationMode) return; // åªåœ¨1Yæ¨¡å¼ä¸‹ç”Ÿæ•ˆ
          currentYearOffset += 1; // å¢åŠ åç§»ï¼Œæ˜¾ç¤ºæ›´æ—©çš„å¹´ä»½
          drawChart(rows, '1Y');
        };
        document.getElementById('nextYear').onclick = ()=>{
          if(!yearNavigationMode) return; // åªåœ¨1Yæ¨¡å¼ä¸‹ç”Ÿæ•ˆ
          currentYearOffset -= 1; // å‡å°‘åç§»ï¼Œæ˜¾ç¤ºæ›´æ™šçš„å¹´ä»½
          drawChart(rows, '1Y');
        };
      }catch(e){
        console.error(e);
        alert('è§£æ CSV æ—¶å‡ºé”™: ' + e.message);
      }
    }

    // åˆå§‹åŒ–é¡µé¢ï¼ˆè½½å…¥ç¤ºä¾‹ï¼‰
    loadFromCSVText(sampleCSV, 'Sample Data');

    // æ–‡ä»¶ä¸Šä¼  / æ‹–æ‹½æ”¯æŒ
    document.getElementById('file').addEventListener('change', (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=> loadFromCSVText(e.target.result, f.name);
      reader.readAsText(f, 'utf-8');
    });
    document.getElementById('resetBtn').addEventListener('click', ()=> loadFromCSVText(sampleCSV, 'Sample Data'));
    document.body.addEventListener('dragover', e => e.preventDefault());
    document.body.addEventListener('drop', e=>{
      e.preventDefault();
      if(e.dataTransfer.files && e.dataTransfer.files.length){
        const f = e.dataTransfer.files[0];
        if(f.name.toLowerCase().endsWith('.csv')){
          const reader = new FileReader();
          reader.onload = (ev) => loadFromCSVText(ev.target.result, f.name);
          reader.readAsText(f, 'utf-8');
        } else {
          alert('è¯·æ‹–æ‹½ CSV æ–‡ä»¶ (.csv)');
        }
      }
    });
  </script>
</body>
</html>
